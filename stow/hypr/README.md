# Hyprland Configuration

## ML4W Dotfiles Startup Flow Analysis

This document explains the complete startup sequence of Hyprland based on the ML4W dotfiles architecture, including key findings and important considerations when replicating or adapting these configurations.

## Complete Startup Flow - From Login to Desktop

### Phase 1: Login Manager
1. **SDDM displays** login screen (using sddm-sugar-candy-git theme from AUR)
2. User selects **"Hyprland"** session from `/usr/share/wayland-sessions/hyprland.desktop`
3. SDDM executes the **Hyprland** binary

### Phase 2: Hyprland Initialization
Hyprland loads `~/.config/hypr/hyprland.conf` which sources configurations in this specific order:

1. **monitor.conf** → Display setup and resolution
2. **cursor.conf** → Mouse cursor configuration
3. **environment.conf** → Environment variables for Wayland/XDG
4. **keyboard.conf** → Keyboard layout and input settings
5. **colors.conf** → Material color scheme (generated by matugen)
6. **autostart.conf** → Launch startup programs *(critical phase - see Phase 3)*
7. **window.conf** → Window behavior settings
8. **decoration.conf** → Window decorations and effects
9. **layout.conf** → Layout configuration
10. **workspace.conf** → Workspace rules and settings
11. **misc.conf** → Miscellaneous settings
12. **keybinding.conf** → All keybindings
13. **windowrule.conf** → Window-specific rules
14. **animation.conf** → Animation settings
15. **XDG Desktop Portal environment** → `dbus-update-activation-environment`
16. **ml4w.conf** → ML4W-specific configurations
17. **custom.conf** → User overrides (never overwritten by updates)

### Phase 3: Autostart Sequence (exec-once commands)
The autostart.conf executes these commands in order:

1. **ML4W Listeners** (`~/.config/ml4w/listeners.sh --startall`)
   - Starts GTK theme change monitor
   - Watches for theme switches to trigger reloads
   
2. **Polkit Agent** (`/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1`)
   - Provides authentication dialogs for privileged operations

3. **Wallpaper Restore** (`~/.config/hypr/scripts/wallpaper-restore.sh`) 
   - Loads last wallpaper from cache: `~/.cache/ml4w/hyprland-dotfiles/current_wallpaper`
   - Falls back to default: `~/.config/ml4w/wallpapers/default.jpg`
   - Executes `waypaper --wallpaper "$wallpaper"`
   - **Critical**: Waypaper's post-command triggers `wallpaper.sh` which:
     - Runs matugen for color generation
     - **Launches Waybar** (`~/.config/waybar/launch.sh`)
     - Starts nwg-dock-hyprland
     - Updates pywalfox browser theme
     - Refreshes SwayNC styling

4. **SwayNC** (`swaync`)
   - Starts the notification daemon

5. **GTK Settings** (`~/.config/hypr/scripts/gtk.sh`)
   - Reads from `~/.config/gtk-3.0/settings.ini`
   - Applies GTK theme, cursor, fonts via gsettings
   - Updates Hyprland cursor: `hyprctl setcursor $cursor_theme $cursor_size`

6. **Hypridle** 
   - Starts idle management for screen locking

7. **Clipboard History** (`wl-paste --watch cliphist store`)
   - Monitors clipboard for history management

8. **ML4W Welcome App** (`~/.config/ml4w/scripts/ml4w-autostart.sh`)
   - 2-second delay before launch
   - Only shows if `~/.cache/ml4w-welcome-autostart` doesn't exist
   - Launches: `flatpak run com.ml4w.welcome`

9. **Cleanup** (`~/.config/hypr/scripts/cleanup.sh`)
   - Removes temporary files and game mode flags

### Phase 4: Runtime Services and Components

#### Active Services:
- **Waybar** - Status bar (launched via wallpaper script chain)
- **SwayNC** - Notification center
- **Hypridle** - Idle/lock management
- **Polkit Agent** - Authentication dialogs
- **XDG Desktop Portals** - File dialogs, screen sharing, etc.
- **GTK Theme Listener** - Monitors theme changes
- **Clipboard Manager** - History tracking

#### The Startup Chain:
```
SDDM → Hyprland → autostart.conf → wallpaper-restore.sh → waypaper 
     → wallpaper.sh → matugen + waybar + nwg-dock
```

## Key Findings and Design Insights

### 1. Waybar Launch Mechanism
**Finding**: Waybar is NOT directly autostarted via exec-once.

**Reason**: It's launched through the wallpaper restoration chain to ensure:
- Colors are generated from wallpaper BEFORE waybar starts
- Waybar always has the correct theme on startup
- Single point of control for theming

**Implementation**: Waypaper config includes post-command hook to run wallpaper.sh

### 2. Dynamic Theming System
**Architecture**:
- Matugen generates Material You colors from wallpaper
- Colors are applied to: Hyprland, Waybar, Wofi, GTK, SwayNC, etc.
- Theme listener monitors GTK settings for light/dark mode switches

**Files Generated**:
- `~/.config/hypr/colors.conf` - Hyprland colors
- `~/.config/waybar/colors.css` - Waybar theme
- `~/.config/wofi/colors.css` - Wofi launcher theme
- `~/.config/gtk-*/colors.css` - GTK application theme

### 3. XDG Desktop Portal Configuration
**Purpose**: Essential for Wayland functionality including:
- Screen sharing in browsers and apps
- Native file dialogs
- Flatpak app permissions
- Screenshot functionality

**Setup**:
- Environment: `XDG_CURRENT_DESKTOP=Hyprland`
- Packages: `xdg-desktop-portal-hyprland` and `xdg-desktop-portal-gtk`
- Window rules ensure dialogs float and center

### 4. Systemd Integration
**Note**: ML4W dotfiles do NOT use systemd user services by default.

**Available but disabled**:
- waybar.service
- swaync.service
- hypridle.service
- hyprpolkitagent.service

**Reasoning**: Direct exec-once provides more control and predictable startup order.

## Important Considerations When Replicating

### 1. Package Dependencies
**Essential packages**:
- Hyprland and utilities: hyprpaper, hypridle, hyprlock, hyprpicker
- UI components: waybar, wofi (or rofi), swaync
- Theme tools: matugen-bin (AUR), pywal, waypaper
- System integration: polkit-gnome, xdg-desktop-portal-hyprland
- Utilities: wl-clipboard, cliphist, grim, slurp

### 2. Directory Structure Requirements
```
~/.config/
├── hypr/
│   ├── conf/          # Modular configuration files
│   ├── scripts/       # Startup and utility scripts
│   └── colors.conf    # Generated by matugen
├── ml4w/              # ML4W framework (optional)
│   ├── settings/      # Configuration files
│   ├── scripts/       # Utility scripts
│   └── wallpapers/    # Default wallpapers
├── waybar/
│   ├── launch.sh      # Waybar startup script
│   └── themes/        # Theme configurations
└── wofi/              # Or rofi for launcher
```

### 3. Critical Configuration Points

#### Wallpaper-Waybar Chain:
If implementing similar auto-theming:
1. Configure waypaper with post-command hook
2. Post-command script must generate colors AND launch waybar
3. Use file locking in waybar launch script to prevent duplicates

#### Environment Variables:
Must be set early in startup:
```bash
exec-once=dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP
env = XDG_CURRENT_DESKTOP,Hyprland
```

#### File Paths:
Many scripts use absolute paths - adjust for your structure:
- Cache directory: `~/.cache/ml4w/hyprland-dotfiles/`
- Settings directory: `~/.config/ml4w/settings/`
- Wallpaper directory: `~/.config/ml4w/wallpapers/`

### 4. Adaptation Strategies

#### Minimal Implementation:
1. Use hyprland.conf with basic autostart
2. Launch waybar directly via exec-once
3. Skip dynamic theming initially
4. Add components incrementally

#### Full Replication:
1. Copy entire directory structure
2. Install all AUR packages including matugen-bin
3. Adapt paths in scripts to your setup
4. Test startup chain thoroughly

#### Hybrid Approach:
1. Take modular config structure
2. Implement your own autostart sequence
3. Use systemd user services if preferred
4. Keep dynamic theming optional

### 5. Common Pitfalls to Avoid

1. **Missing matugen**: Wallpaper script will fail if matugen isn't installed
2. **Incorrect paths**: Scripts use hardcoded paths that need adjustment
3. **Missing cache directories**: Create cache folders before first run
4. **Portal conflicts**: Don't run multiple portal implementations
5. **Theme listener loops**: Ensure theme changes don't trigger infinite loops

### 6. Testing and Debugging

#### Check startup order:
```bash
journalctl --user -f  # Monitor user services
hyprctl clients        # List running windows
ps aux | grep waybar   # Check if waybar is running
```

#### Common issues:
- Waybar not starting: Check wallpaper script execution
- No colors: Verify matugen installation and templates
- Portal issues: Check XDG_CURRENT_DESKTOP environment
- Theme not applying: Verify GTK settings file exists

## Conclusion

The ML4W dotfiles represent a sophisticated Hyprland setup with clever design choices around theming and component initialization. The indirect waybar launch through wallpaper restoration ensures consistent theming, while the modular configuration structure allows for easy customization. When replicating, understanding the startup chain and dependencies is crucial for a functional setup.